module.exports.config = {
	name: "join",
	eventType: ["log:subscribe"],
	version: "1.0.1",
	credits: "Deku",
	description: "Notify bots or people entering the group",
	dependencies: {
		"fs-extra": ""
	}
};
module.exports.run = async function({ api, event }) {
const request = require("request");
	const { threadID } = event;
	if (event.logMessageData.addedParticipants.some(i => i.userFbId == api.getCurrentUserID())) {
		api.changeNickname(`Â» ${global.config.PREFIX} Â« ${(!global.config.BOTNAME) ? " " : global.config.BOTNAME}`, threadID, api.getCurrentUserID());
		return api.sendMessage(`${global.config.BOTNAME} Connected successfully!
Thank you for choosing ${global.config.BOTNAME} bot, have fun using it.`, threadID);
  api.sendMessage({sticker: 958510944241784}, threadID);
	}
	else {
		try {
    const request = require("request");
			const fs = global.nodemodule["fs-extra"];
			let { threadName, participantIDs, imageSrc } = await api.getThreadInfo(threadID);
const moment = require("moment-timezone");
      var time = moment.tz("Asia/Ho_Chi_Minh").format("DD/MM/YYYY || HH:mm:s || (dddd)");
      var hours = moment.tz("Asia/Ho_Chi_Minh").format("HH");
var threadInfo = await api.getThreadInfo(threadID);
      const uid = (event.logMessageData.leftParticipantFbId);
			const threadData = global.data.threadData.get(parseInt(threadID)) || {};		
			var mentions = [], nameArray = [], memLength = [], i = 0;
    let addedParticipants1 = event.logMessageData.addedParticipants;
        for (let newParticipant of addedParticipants1) {
   let userID = newParticipant.userFbId
api.getUserInfo(parseInt(userID), (err, data) => {
      if(err){ return console.log(err)}
     var obj = Object.keys(data);
  var tite = ["https://i.imgur.com/oeyVcRU.jpg", "https://i.imgur.com/qDG55dz.jpg", "https://i.imgur.com/4GGnm3O.jpg", "https://i.imgur.com/cak3TM4.jpg"];
  
  var linkava1 = tite[Math.floor(Math.random() * tite.length)];
     var linkava = ["https://i.imgur.com/EsQBZY4.jpg"];
    var userName = data[obj].name.replace("@", "");
  if (userID !== api.getCurrentUserID()) {  
				nameArray.push(userName);
				mentions.push({ tag: userName, id: userID, fromIndex: 0 });
memLength.push(participantIDs.length - i++);
memLength.sort((a, b) => a - b);
(typeof threadData.customJoin == "undefined") ? msg = "â€â” ğ“ğ¡ğ¨Ì‚ğ§ğ  ğğšÌğ¨ â”\nâ¾ ğğšÌ‚ğ² ğ†ğ¢ğ¨Ì›Ì€ ğ‹ğšÌ€: {time}\nâ¾ ğ—ğ¢ğ§ ğ‚ğ¡ğšÌ€ğ¨ ğŒğ®Ì›Ì€ğ§ğ  ğ“ğ¡ğšÌ€ğ§ğ¡ ğ•ğ¢ğÌ‚ğ§ ğŒğ¨Ì›Ìğ¢ ğ‚ğ®Ì‰ğš ğ‚ğ¡ğ®Ìğ§ğ  ğ“ğš !!!\nâ–­â–­â–­â–­ [ ğˆğğ…ğ ] â–­â–­â–­â–­\nâ‹„ ğğšğ¦ğ: {uName} \nâ‹„ ğ”ğ«ğ¥ ğ…ğ: https://www.facebook.com/{iduser}\nâ‹„ ğğšÌ£ğ§ ğ€Ì‚Ìğ² ğ‹ğšÌ€ ğ“ğ¡ğšÌ€ğ§ğ¡ ğ•ğ¢ğÌ‚ğ§ ğ’ğ¨Ì‚Ì {soThanhVien} ğ‚ğ®Ì‰ğš {threadName} !!\nâ‹„ ğ‚ğ¡ğ®Ìğœ {uName} ğğ®ğ¨Ì‚Ì‰ğ¢ {session} ğ•ğ®ğ¢ ğ•ğÌ‰ ğŒğ¨ğšğ¡ğ¡ ğŸ’\nâ–­â–­â–­â–­â–­â–­â–­â–­â–­â–­â–­â–­\nâ—ˆ {uName} ğ•ğšÌ€ğ¨ ğğ¡ğ¨Ìğ¦ ğğ¨Ì›Ì‰ğ¢ ğ‹ğ¨Ì›Ì€ğ¢ ğŒğ¨Ì›Ì€ğ¢ ğ‚ğ®Ì‰ğš \nâ—ˆ ğ”ğ«ğ¥ ğ…ğ: https://www.facebook.com/{idauthor}\nğğšÌ£ğ§ ğ¤ğ¡ğ¨Ì‚ğ§ğ  ğ­ğ®Ì›ğ¨Ì›ğ§ğ  ğ­ğšÌğœ ğ›ğšÌ£ğ§ ğ¬ğÌƒ ğ«ğš Ä‘ğšÌ‰ğ¨ ğ¨Ì›Ì‰ ğŸ€" : msg = threadData.customJoin;
			msg = msg
         .replace(/\{idauthor}/g, event.author)
        .replace(/\{iduser}/g, uid)
        .replace(/\{session}/g, hours <= 10 ? "ğ˜€ğ—®Ìğ—»ğ—´" : 
    hours > 10 && hours <= 12 ? "ğ˜ğ—¿ğ˜‚Ì›ğ—®" :
    hours > 12 && hours <= 18 ? "ğ—°ğ—µğ—¶ğ—²Ì‚Ì€ğ˜‚" : "ğ˜ğ—¼Ì‚Ìğ—¶ ")
    .replace(/\{time}/g, time)
			.replace(/\{uName}/g, nameArray.join(', '))
			.replace(/\{type}/g, (memLength.length > 1) ?  'you' : 'Friend')
			.replace(/\{soThanhVien}/g, memLength.join(', '))
			.replace(/\{threadName}/g, threadName);			
var random1 = [`https://api.reikomods.repl.co/canvas/welcome2?uid=${userID}&name=>Â»Â»Â»Â»${userName}&bg=${linkava1}&namegc=${threadName}&member=${participantIDs.length}`, `https://api.reikomods.repl.co/canvas/welcome?uid=${userID}&name=${userName}&bg=https://i.imgur.com/mlL0nIF.jpg&namegc=${threadName}&member=${participantIDs.length}`];
  var randomm = random1[Math.floor(Math.random() * random1.length)];    
	let callback = function () {
	 return api.sendMessage({body: msg, attachment: fs.createReadStream(__dirname + `/cache/come.jpg`), mentions
                    }, event.threadID, () => fs.unlinkSync(__dirname + `/cache/come.jpg`));
   
                };
                request(encodeURI(randomm)).pipe(fs.createWriteStream(__dirname + `/cache/come.jpg`)).on("close", callback);
     }
})
        }
    }catch (err) {
            return console.log("ERROR: "+err);
    }
	}
                           }